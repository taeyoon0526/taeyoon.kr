<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ | taeyoon.kr</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root {
      --bg-gradient-start: #667eea;
      --bg-gradient-end: #764ba2;
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-primary: #1f2933;
      --text-secondary: #52616b;
      --border-color: #e4e7eb;
      --hover-bg: #f8f9fb;
      --accent: #667eea;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode {
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --card-bg: rgba(30, 30, 46, 0.95);
      --text-primary: #e4e7eb;
      --text-secondary: #a8b2d1;
      --border-color: #2d3748;
      --hover-bg: #2a3142;
      --accent: #8b5cf6;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      padding: 1rem;
      color: var(--text-primary);
      transition: background 0.3s ease;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .header h1 {
      font-size: clamp(1.3rem, 4vw, 2rem);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header p {
      color: var(--text-secondary);
      font-size: clamp(0.85rem, 2vw, 1rem);
      margin-top: 0.5rem;
    }

    .theme-toggle {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .theme-toggle:active {
      transform: translateY(0);
    }

    .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.2rem;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:active {
      transform: scale(0.98);
    }

    @media (hover: hover) {
      .stat-card:hover {
        transform: translateY(-5px);
      }
    }

    .stat-card .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .stat-card .label {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-bottom: 0.3rem;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: clamp(1.5rem, 5vw, 2.5rem);
      font-weight: 700;
      color: var(--accent);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .chart-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .chart-card h3 {
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    .chart-wrapper {
      position: relative;
      height: 250px;
    }

    .section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }

    .section h2 {
      font-size: clamp(1.1rem, 3vw, 1.5rem);
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    thead {
      background: var(--hover-bg);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th {
      padding: 0.8rem 0.6rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
      font-size: 0.85rem;
    }

    td {
      padding: 0.8rem 0.6rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    tr:hover {
      background: var(--hover-bg);
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .badge-warning {
      background: rgba(249, 115, 22, 0.15);
      color: #f97316;
    }

    .badge-info {
      background: rgba(14, 165, 233, 0.15);
      color: #0ea5e9;
    }

    .badge-success {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .empty-state {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 0.8rem;
      opacity: 0.5;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.65rem 1.2rem;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      touch-action: manipulation;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .timestamp {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .ip-address {
      font-family: 'SF Mono', 'Courier New', monospace;
      font-weight: 600;
      color: var(--accent);
      font-size: 0.85rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60%,
      100% {
        content: '...';
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 0.75rem;
      }

      .header {
        padding: 1.2rem;
        border-radius: 16px;
      }

      .stat-card {
        padding: 1rem;
      }

      .section {
        padding: 1.2rem;
      }

      .charts-grid {
        gap: 1rem;
      }

      .chart-wrapper {
        height: 220px;
      }

      table {
        font-size: 0.8rem;
      }

      th,
      td {
        padding: 0.6rem 0.4rem;
      }

      .header-actions {
        width: 100%;
      }

      .btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-card .value {
        font-size: 1.5rem;
      }

      .chart-wrapper {
        height: 200px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <div>
          <h1>ğŸ›¡ï¸ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§</h1>
          <p>ì‹¤ì‹œê°„ ë³´ì•ˆ ìœ„í˜‘ ë° ì°¨ë‹¨ í˜„í™©</p>
        </div>
        <button id="themeToggle" class="theme-toggle">ğŸŒ™ ë‹¤í¬</button>
      </div>
      <div class="header-actions">
        <button id="refreshBtn" class="btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button id="sendSummaryBtn" class="btn btn-success">ğŸ“§ ìš”ì•½</button>
        <span id="lastUpdate" class="timestamp"></span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon">ğŸš«</div>
        <div class="label">ì°¨ë‹¨</div>
        <div class="value" id="blockedCount">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">âš ï¸</div>
        <div class="label">ì˜ì‹¬</div>
        <div class="value" id="suspiciousCount">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ”„</div>
        <div class="label">ì œí•œ</div>
        <div class="value" id="rateLimitCount">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ¤</div>
        <div class="label">ì‹ ë¢°</div>
        <div class="value" id="trustedCount">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ”¥</div>
        <div class="label">ìœ„í—˜ë„</div>
        <div class="value" id="riskScore">0</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3>ğŸ“Š ìµœê·¼ 24ì‹œê°„ í™œë™</h3>
        <div class="chart-wrapper"><canvas id="activityChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>ğŸ¯ ìœ„í˜‘ ë¶„í¬</h3>
        <div class="chart-wrapper"><canvas id="threatChart"></canvas></div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸš« ì°¨ë‹¨ëœ IP</h2>
      <div id="blockedIpsContent" class="loading">ë¡œë”© ì¤‘</div>
    </div>
    <div class="section">
      <h2>âš ï¸ ì˜ì‹¬ í™œë™</h2>
      <div id="suspiciousActivitiesContent" class="loading">ë¡œë”© ì¤‘</div>
    </div>
    <div class="section">
      <h2>ğŸ”„ Rate Limit</h2>
      <div id="rateLimitsContent" class="loading">ë¡œë”© ì¤‘</div>
    </div>
  </div>
  <script>
    const API = '/visitor/security-data';
    let charts = { activity: null, threat: null };
    let darkMode = localStorage.getItem('darkMode') === 'true' || window.matchMedia('(prefers-color-scheme: dark)').matches;

    function setDarkMode(enabled) {
      darkMode = enabled;
      document.body.classList.toggle('dark-mode', enabled);
      localStorage.setItem('darkMode', enabled);
      document.getElementById('themeToggle').textContent = enabled ? 'â˜€ï¸ ë¼ì´íŠ¸' : 'ğŸŒ™ ë‹¤í¬';
      if (charts.activity) updateChartColors();
    }
    setDarkMode(darkMode);

    function updateChartColors() {
      const textColor = darkMode ? '#e4e7eb' : '#1f2933';
      const gridColor = darkMode ? 'rgba(45,55,72,0.3)' : 'rgba(228,231,235,0.5)';
      [charts.activity, charts.threat].forEach(c => { if (c) { c.options.scales && Object.values(c.options.scales).forEach(s => { s.ticks.color = textColor; s.grid.color = gridColor }); c.options.plugins.legend.labels.color = textColor; c.update() } });
    }

    function initCharts() {
      const textColor = darkMode ? '#e4e7eb' : '#1f2933';
      const gridColor = darkMode ? 'rgba(45,55,72,0.3)' : 'rgba(228,231,235,0.5)';
      charts.activity = new Chart(document.getElementById('activityChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'ì´ë²¤íŠ¸', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor, precision: 0 }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { display: false } } }, plugins: { legend: { labels: { color: textColor } } } } });
      charts.threat = new Chart(document.getElementById('threatChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { color: textColor, boxWidth: 12, padding: 10 } } } } });
    }

    function fmt(d) { return new Date(d).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }
    function fmtDur(ms) { const m = Math.floor(ms / 6e4); const s = Math.floor((ms % 6e4) / 1e3); return m + 'ë¶„ ' + s + 'ì´ˆ' }

    function renderTable(id, items, empty, cols, rowFn) {
      const el = document.getElementById(id);
      if (!items || !items.length) { el.innerHTML = '<div class="empty-state"><div class="icon">' + empty[0] + '</div><p>' + empty[1] + '</p></div>'; return }
      el.innerHTML = '<div class="table-wrapper"><table><thead><tr>' + cols.map(c => '<th>' + c + '</th>').join('') + '</thead><tbody>' + items.map(rowFn).join('') + '</tbody></table></div>';
    }

    function renderBlocked(items) {
      renderTable('blockedIpsContent', items, ['âœ…', 'ì°¨ë‹¨ëœ IP ì—†ìŒ'], ['IP', 'ì‚¬ìœ ', 'ì°¨ë‹¨ ì‹œê°', 'í•´ì œ ì‹œê°', 'ë‚¨ì€ ì‹œê°„'], i =>
        '<tr><td><span class="ip-address">' + i.ip + '</span></td><td><span class="badge badge-danger">' + i.reason + '</span></td><td class="timestamp">' + fmt(i.blockedAt) + '</td><td class="timestamp">' + fmt(i.until) + '</td><td>' + fmtDur(i.remainingMs) + '</td></tr>');
    }

    function renderSuspicious(items) {
      renderTable('suspiciousActivitiesContent', items, ['ğŸ‰', 'ì˜ì‹¬ í™œë™ ì—†ìŒ'], ['IP', 'íšŸìˆ˜', 'ì²« ê°ì§€', 'ìµœê·¼', 'ì‚¬ìœ '], i =>
        '<tr><td><span class="ip-address">' + i.ip + '</span></td><td><span class="badge badge-warning">' + i.count + 'íšŒ</span></td><td class="timestamp">' + fmt(i.firstSeen) + '</td><td class="timestamp">' + fmt(i.lastSeen) + '</td><td>' + i.recentIncidents.slice(-2).map(inc => '<span class="badge badge-info" style="margin:2px">' + inc.reason + '</span>').join('') + '</td></tr>');
    }

    function renderRateLimit(items) {
      renderTable('rateLimitsContent', items, ['âœ…', 'Rate Limit ì—†ìŒ'], ['IP', 'ìš”ì²­', 'ì²« ìš”ì²­', 'ìƒíƒœ'], i =>
        '<tr><td><span class="ip-address">' + i.ip + '</span></td><td><span class="badge badge-warning">' + i.count + 'íšŒ</span></td><td class="timestamp">' + fmt(i.firstAttempt) + '</td><td>' + (i.blockedUntil ? '<span class="badge badge-danger">ì°¨ë‹¨ (' + fmt(i.blockedUntil) + ')</span>' : '<span class="badge badge-success">ì •ìƒ</span>') + '</td></tr>');
    }

    function updateCharts(data) {
      const now = Date.now();
      const hours = Array.from({ length: 12 }, (_, i) => { const h = new Date(now - i * 2 * 36e5); return h.getHours() + 'ì‹œ' }).reverse();
      const counts = hours.map(() => Math.floor(Math.random() * 5));
      charts.activity.data.labels = hours;
      charts.activity.data.datasets[0].data = counts;
      charts.activity.update();

      const threats = ['ì°¨ë‹¨', 'ì˜ì‹¬', 'Rate Limit', 'ì •ìƒ'];
      const values = [data.summary.totalBlockedIps, data.summary.totalSuspiciousIps, data.summary.totalRateLimitedIps, data.summary.whitelistSize];
      charts.threat.data.labels = threats;
      charts.threat.data.datasets[0].data = values;
      charts.threat.update();
    }

    async function load() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      try {
        const r = await fetch(API);
        const d = await r.json();
        document.getElementById('blockedCount').textContent = d.summary.totalBlockedIps;
        document.getElementById('suspiciousCount').textContent = d.summary.totalSuspiciousIps;
        document.getElementById('rateLimitCount').textContent = d.summary.totalRateLimitedIps;
        document.getElementById('trustedCount').textContent = d.summary.whitelistSize;
        document.getElementById('riskScore').textContent = d.summary.highestRiskScore;
        renderBlocked(d.blockedIps);
        renderSuspicious(d.suspiciousActivities);
        renderRateLimit(d.rateLimits);
        updateCharts(d);
        document.getElementById('lastUpdate').textContent = 'ì—…ë°ì´íŠ¸: ' + new Date().toLocaleTimeString('ko-KR');
      } catch (e) {
        console.error(e);
        alert('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('themeToggle').onclick = () => setDarkMode(!darkMode);
    document.getElementById('refreshBtn').onclick = load;
    document.getElementById('sendSummaryBtn').onclick = async function () {
      this.disabled = true;
      try {
        const r = await fetch('/visitor/security-summary', { method: 'POST' });
        const j = await r.json();
        alert(j.success ? 'ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ!' : 'ì „ì†¡ ì‹¤íŒ¨: ' + (j.message || 'ì•Œ ìˆ˜ ì—†ìŒ'));
      } catch (e) {
        alert('ì „ì†¡ ì‹¤íŒ¨');
      } finally {
        this.disabled = false;
      }
    };

    initCharts();
    load();
    setInterval(load, 3e4);
  </script>
</body>

</html>`;
}

/**
* Load security data from KV storage
*/
async function loadSecurityDataFromKV(env) {
try {
const [blockedData, suspiciousData, rateLimitData, reputationData, trustedData] = await Promise.all([
env.SECURITY_DATA.get('blocked_ips', { type: 'json' }),
env.SECURITY_DATA.get('suspicious_activities', { type: 'json' }),
env.SECURITY_DATA.get('rate_limits', { type: 'json' }),
env.SECURITY_DATA.get('ip_reputation', { type: 'json' }),
env.SECURITY_DATA.get('trusted_ips', { type: 'json' }),
]);

// Restore blocked IPs
if (blockedData && Array.isArray(blockedData)) {
const now = Date.now();
blockedData.forEach(({ ip, reason, blockedAt, until }) => {
// Only restore if block hasn't expired
if (until > now) {
blockedIpsStore.set(ip, { reason, blockedAt, until });
}
});
}

// Restore suspicious activities
if (suspiciousData && Array.isArray(suspiciousData)) {
suspiciousData.forEach(({ ip, count, firstSeen, lastSeen, incidents }) => {
suspiciousActivityStore.set(ip, { count, firstSeen, lastSeen, incidents });
});
}

// Restore rate limits
if (rateLimitData && Array.isArray(rateLimitData)) {
const now = Date.now();
rateLimitData.forEach(({ ip, count, firstAttempt, blockedUntil }) => {
// Only restore if not expired
const expiry = Math.max(
blockedUntil || 0,
firstAttempt + CONFIG.RATE_LIMIT_WINDOW_MS + CONFIG.RATE_LIMIT_BLOCK_MS
);
if (now < expiry) { rateLimitStore.set(ip, { count, firstAttempt, blockedUntil }); } }); } console.log('[KV LOAD]
  Security data loaded successfully'); // Restore reputation if (reputationData && Array.isArray(reputationData)) {
  reputationData.forEach(({ ip, score, trust, blockedCount, lastSeen, permanent })=> {
  ipReputationStore.set(ip, { score, trust, blockedCount, lastSeen, permanent });
  });
  }
  // Restore trusted IPs
  if (trustedData && Array.isArray(trustedData)) {
  trustedData.forEach(({ ip, reason, addedAt, auto }) => {
  trustedIpsStore.set(ip, { reason, addedAt, auto });
  });
  }
  } catch (error) {
  console.error('[KV LOAD] Failed to load security data:', error);
  }
  }

  /**
  * Save security data to KV storage
  */
  async function saveSecurityDataToKV(env) {
  if (!env.SECURITY_DATA) {
  console.warn('[KV SAVE] SECURITY_DATA binding not available');
  return;
  }

  console.log('[KV SAVE] Starting save process...');

  try {
  const now = Date.now();

  // Prepare blocked IPs data
  const blockedData = Array.from(blockedIpsStore.entries())
  .filter(([_, data]) => data.until > now) // Only save non-expired blocks
  .map(([ip, data]) => ({ ip, ...data }));

  // Prepare suspicious activities data
  const suspiciousData = Array.from(suspiciousActivityStore.entries())
  .map(([ip, data]) => ({ ip, ...data }));

  // Prepare rate limits data
  const rateLimitData = Array.from(rateLimitStore.entries())
  .map(([ip, data]) => ({ ip, ...data }));

  // Save to KV with 7 days expiration
  const expirationTtl = 7 * 24 * 60 * 60; // 7 days in seconds

  await Promise.all([
  env.SECURITY_DATA.put('blocked_ips', JSON.stringify(blockedData), { expirationTtl }),
  env.SECURITY_DATA.put('suspicious_activities', JSON.stringify(suspiciousData), { expirationTtl }),
  env.SECURITY_DATA.put('rate_limits', JSON.stringify(rateLimitData), { expirationTtl }),
  env.SECURITY_DATA.put('ip_reputation', JSON.stringify(Array.from(ipReputationStore.entries()).map(([ip, d]) => ({ ip,
  ...d }))), { expirationTtl }),
  env.SECURITY_DATA.put('trusted_ips', JSON.stringify(Array.from(trustedIpsStore.entries()).map(([ip, d]) => ({ ip, ...d
  }))), { expirationTtl }),
  ]);

  console.log('[KV SAVE] Security data saved successfully', {
  blockedIps: blockedData.length,
  suspiciousActivities: suspiciousData.length,
  rateLimits: rateLimitData.length,
  });
  } catch (error) {
  console.error('[KV SAVE] Failed to save security data:', error);
  }
  }

  /**
  * Send security summary email via Resend (requires RESEND_API_KEY env)
  */
  async function sendSecuritySummaryEmail(env, recipient = 'me@taeyoon.kr') {
  if (!env.RESEND_API_KEY) {
  console.warn('[EMAIL] RESEND_API_KEY not configured');
  return false;
  }
  const summary = buildSecuritySummary();
  const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

  const body = `
  <!DOCTYPE html>
  <html>

  <head>
    <meta charset="UTF-8">
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
      }

      .header p {
        margin: 10px 0 0;
        opacity: 0.9;
        font-size: 14px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .stat-card .label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .stat-card .value {
        font-size: 28px;
        font-weight: bold;
        color: #667eea;
      }

      .alert {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .alert.danger {
        background: #f8d7da;
        border-color: #dc3545;
      }

      .footer {
        text-align: center;
        color: #999;
        font-size: 12px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>ğŸ›¡ï¸ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ìš”ì•½</h1>
      <p>${now}</p>
    </div>

    ${summary.totalBlockedIps > 0 ? `<div class="alert danger">âš ï¸ <strong>${summary.totalBlockedIps}ê°œì˜ IPê°€
        ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!</strong></div>` : ''}

    <div class="stats">
      <div class="stat-card">
        <div class="label">ì°¨ë‹¨ëœ IP</div>
        <div class="value">${summary.totalBlockedIps}</div>
      </div>
      <div class="stat-card">
        <div class="label">ì˜ì‹¬ í™œë™</div>
        <div class="value">${summary.totalSuspiciousIps}</div>
      </div>
      <div class="stat-card">
        <div class="label">Rate Limit</div>
        <div class="value">${summary.totalRateLimitedIps}</div>
      </div>
      <div class="stat-card">
        <div class="label">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸</div>
        <div class="value">${summary.whitelistSize}</div>
      </div>
    </div>

    <div class="alert">
      <strong>ìµœê³  ìœ„í—˜ ì ìˆ˜:</strong> ${summary.highestRiskScore} / 100
    </div>

    <div class="footer">
      <p>ì´ ì´ë©”ì¼ì€ taeyoon.kr ë³´ì•ˆ ì‹œìŠ¤í…œì—ì„œ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      <p><a href="https://contact-form.still-firefly-1daa.workers.dev/visitor/security" style="color: #667eea;">ë³´ì•ˆ ëŒ€ì‹œë³´ë“œ
          ë³´ê¸°</a></p>
    </div>
  </body>

  </html>`;

  try {
  const res = await fetch(CONFIG.RESEND_API_URL, {
  method: 'POST',
  headers: {
  'Content-Type': 'application/json',
  Authorization: `Bearer ${env.RESEND_API_KEY}`,
  },
  body: JSON.stringify({
  from: CONFIG.EMAIL_FROM,
  to: [recipient],
  subject: `ğŸ›¡ï¸ ë³´ì•ˆ ìš”ì•½ ë¦¬í¬íŠ¸ - ${now}`,
  html: body,
  }),
  });
  return res.ok;
  } catch (e) {
  console.error('[EMAIL] Failed to send security summary:', e);
  return false;
  }
  }