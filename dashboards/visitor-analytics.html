<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°©ë¬¸ì ë¶„ì„ | taeyoon.kr</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
    }

    .chart-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .btn-back {
      display: inline-block;
      padding: 12px 30px;
      background: white;
      color: #f5576c;
      text-decoration: none;
      border-radius: 25px;
      font-weight: 600;
      margin: 20px 0;
      transition: transform 0.2s;
    }

    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“ˆ ë°©ë¬¸ì ë¶„ì„</h1>
    <a href="/admin" class="btn-back">â† Admin Dashboardë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="chart-container">
      <h2>ë¸Œë¼ìš°ì € ì ìœ ìœ¨</h2>
      <canvas id="browserChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>ì‹œê°„ëŒ€ë³„ ë°©ë¬¸</h2>
      <canvas id="timeChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>OS ë¶„í¬</h2>
      <canvas id="osChart"></canvas>
    </div>
  </div>

  <script>
    async function loadAnalytics() {
      try {
        // ì‹¤ì‹œê°„ APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('/api/visitor/data');
        if (!response.ok) {
          throw new Error('API ì‘ë‹µ ì‹¤íŒ¨: ' + response.status);
        }
        
        const apiData = await response.json();
        const visitors = apiData.visitors || [];
        
        // User Agent íŒŒì‹± (ê°„ë‹¨í•œ ë²„ì „)
        const browserCount = { Chrome: 0, Safari: 0, Firefox: 0, Edge: 0, Other: 0 };
        const osCount = { Windows: 0, macOS: 0, Linux: 0, Android: 0, iOS: 0, Other: 0 };
        const hourlyCount = new Array(24).fill(0);
        
        visitors.forEach(v => {
          const ua = (v.userAgent || '').toLowerCase();
          
          // ë¸Œë¼ìš°ì € ê°ì§€
          if (ua.includes('edg/')) browserCount.Edge++;
          else if (ua.includes('chrome')) browserCount.Chrome++;
          else if (ua.includes('safari') && !ua.includes('chrome')) browserCount.Safari++;
          else if (ua.includes('firefox')) browserCount.Firefox++;
          else browserCount.Other++;
          
          // OS ê°ì§€
          if (ua.includes('windows')) osCount.Windows++;
          else if (ua.includes('mac os')) osCount.macOS++;
          else if (ua.includes('linux') && !ua.includes('android')) osCount.Linux++;
          else if (ua.includes('android')) osCount.Android++;
          else if (ua.includes('iphone') || ua.includes('ipad')) osCount.iOS++;
          else osCount.Other++;
          
          // ì‹œê°„ëŒ€ë³„ ë¶„ì„
          if (v.timestamp) {
            const hour = new Date(v.timestamp).getHours();
            hourlyCount[hour]++;
          }
        });
        
        // ì‹œê°„ëŒ€ë³„ ë°ì´í„° (4ì‹œê°„ ê°„ê²©)
        const timeLabels = [];
        const timeData = [];
        for (let h = 0; h < 24; h += 4) {
          timeLabels.push(h.toString().padStart(2, '0') + ':00');
          // 4ì‹œê°„ êµ¬ê°„ì˜ í•©ê³„
          let sum = 0;
          for (let i = 0; i < 4 && (h + i) < 24; i++) {
            sum += hourlyCount[h + i];
          }
          timeData.push(sum);
        }

        // Browser chart
        new Chart(document.getElementById('browserChart'), {
          type: 'bar',
          data: {
            labels: Object.keys(browserCount),
            datasets: [{
              label: 'ì‚¬ìš©ì ìˆ˜',
              data: Object.values(browserCount),
              backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
            }]
          },
          options: { 
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                    return 'ì‚¬ìš©ì: ' + context.parsed.y + 'ëª… (' + percentage + '%)';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });

        // Time chart
        new Chart(document.getElementById('timeChart'), {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [{
              label: 'ì‹œê°„ëŒ€ë³„ ë°©ë¬¸',
              data: timeData,
              borderColor: '#f5576c',
              backgroundColor: 'rgba(245, 87, 108, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: { 
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'ë°©ë¬¸: ' + context.parsed.y + 'íšŒ';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });

        // OS chart
        new Chart(document.getElementById('osChart'), {
          type: 'pie',
          data: {
            labels: Object.keys(osCount).filter(k => osCount[k] > 0),
            datasets: [{
              data: Object.values(osCount).filter(v => v > 0),
              backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#f5576c']
            }]
          },
          options: { 
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return label + ': ' + value + 'ëª… (' + percentage + '%)';
                  }
                }
              }
            }
          }
        });
        
        console.log('ë°©ë¬¸ì ë¶„ì„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', {
          totalVisitors: visitors.length,
          browsers: browserCount,
          os: osCount
        });
      } catch (err) {
        console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', err);
        alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + err.message);
      }
    }

    loadAnalytics();
    
    // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadAnalytics, 30000);
  </script>
</body>

</html>